<!DOCTYPE HTML>
<html>

<head>
    <title>Methane Detection</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
</head>

<body class="is-preload">
    <div id="page-wrapper">
        <!-- Header -->
        <header id="header">
            <div class="logo container">
                <div>
                    <h1><a href="{{ url_for('index') }}" id="logo">Methane</a></h1>
                    <p>Detection app</p>
                </div>
            </div>
        </header>

        <!-- Nav -->
        <nav id="nav">
            <ul>
                <li><a href="{{ url_for('index') }}">Home</a></li>
                <li class="current"><a href="{{ url_for('methane') }}">Methane Detection</a></li>
                <li><a href="{{ url_for('time_series') }}">Time series</a></li>
            </ul>
        </nav>

        <!-- Main -->
        <section id="main" style="padding: 0em 0 6em 0 !important;">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="content">

                            <!-- Content -->

                            <article class="box page-content">

                                <header>
                                    <h2>Detection with EMIT data input</h2>
                                    <a target="_blank"
                                        href="https://search.earthdata.nasa.gov/search/granules?p=C2408009906-LPCLOUD&q=EMIT&sb[0]=-117.21973%2C33.41752%2C-116.50781%2C33.95384&tl=1727599132!3!!&lat=32.01566276433157&long=-119.390625&zoom=6"
                                        class="nasa-link" title="Access EMIT data from NASA Earth Data">NASA Website</a>
                                </header>
                                <div class="box">
                                    <form id="methaneForm" class="section">
                                        <div class="row gtr-uniform">
                                            <div class="col-12">
                                                <label for="emitId">EMIT ID:</label>
                                                <input type="text" name="emitId" id="emitId"
                                                    placeholder="Enter EMIT ID (e.g., EMIT_L1B_RAD_001_20240326T214529_2408614_001)"
                                                    required />
                                            </div>
                                            <div class="col-12">
                                                <button type="submit" class="button primary large">Analyze
                                                    Methane</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <!-- Replace the current loading section with this -->
                                <div id="loadingSection" class="box" style="display: none;">
                                    <div class="section" style="text-align: center;">
                                        <h3>Processing Data</h3>
                                        <p>Please wait our Model is in action. This may take several minutes...</p>
                                        <div class="loader"></div> <!-- Changed from spinner to loader -->
                                    </div>
                                </div>
                                <!-- Results Section -->
                                <div id="resultsSection" class="box" style="display: none;">
                                    <div class="section">
                                        <h3>Analysis Results</h3>

                                        <!-- Visualization -->
                                        <div class="image featured">
                                            <img id="resultImage" src="" alt="Methane Analysis Visualization"
                                                style="width: 100%;" />
                                        </div>

                                        <!-- Statistics -->
                                        <div class="row">
                                            <div class="col-6 col-12-medium">
                                                <h4>Location Information</h4>
                                                <ul id="locationInfo"></ul>
                                            </div>
                                            <div class="col-6 col-12-medium">
                                                <h4>Detection Statistics</h4>
                                                <ul id="statistics"></ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Error Message -->
                                <div id="errorSection" class="box" style="display: none;">
                                    <div class="section">
                                        <h3>Error</h3>
                                        <p id="errorMessage" style="color: #ff3860;"></p>
                                    </div>
                                </div>
                                <section style="margin-bottom: 10px;">
                                    <span class="image featured"><img src="assets/images/b.jpg" alt="" /></span>
                                </section>
                                <section id="conclusionSection" class="box" style="display: none;">
                                    <h3>Analysis Conclusion</h3>
                                    <div id="conclusionText" class="section">
                                        <p>Generating conclusion...</p>
                                    </div>
                                </section>

                            </article>

                        </div>
                    </div>
                </div>
            </div>
        </section>
        <footer id="footer">
            <div class="container">
                <div class="row gtr-200">
                    <div class="col-12">

                        <!-- About -->
                        <section>
                            <h2 class="major"><span>About This Application</span></h2>
                            <p> This application is designed to detect methane emissions using emitted data and perform
                                time series analysis on methane levels through the Google Earth Engine. This project was
                                developed as part of the <strong>Applied Data Science</strong> course at <strong>San
                                    Jose State University</strong> by <strong>Team-6</strong>, under the guidance of
                                Professor <strong>Dr.Simon Shim</strong>. </p>
                        </section>
                    </div>
                    <div class="col-12">

                        <!-- Contact -->
                        <section>
                            <h2 class="major"><span>Get in touch</span></h2>
                            <ul class="contact">
                                <li><a class="icon brands fa-facebook-f" href="#"><span
                                            class="label">Facebook</span></a></li>
                                <li><a class="icon brands fa-twitter" href="#"><span class="label">Twitter</span></a>
                                </li>
                                <li><a class="icon brands fa-instagram" href="#"><span
                                            class="label">Instagram</span></a></li>
                                <li><a class="icon brands fa-dribbble" href="#"><span class="label">Dribbble</span></a>
                                </li>
                                <li><a class="icon brands fa-linkedin-in" href="#"><span
                                            class="label">LinkedIn</span></a></li>
                            </ul>
                        </section>

                    </div>
                </div>

                <!-- Copyright -->
                <div id="copyright">
                    <ul class="menu">
                        <li>&copy; Team-6. All rights reserved</li>
                    </ul>
                </div>

            </div>
        </footer>
    </div>
    </div>
    </div>
    </section>
    </div>

    <style>
        #conclusionText {
            padding: 1em;
            line-height: 1.6;
        }
    
        #conclusionText p {
            margin: 0;
        }
    
        #conclusionText .error {
            color: #ff3860;
}
        .spinner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, transparent 0%, transparent 10%, #3498db 100%);
            animation: rotate 1.5s cubic-bezier(0.5, 0.1, 0.15, 1) infinite;
            position: relative;
            margin: 30px auto;
        }

        .spinner::before {
            content: '';
            position: absolute;
            inset: 5px;
            border-radius: 50%;
            background-color: white;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        #statistics li,
        #locationInfo li {
            list-style: none;
            margin-bottom: 0.5em;
        }

        .box {
            margin-bottom: 2em;
        }
    </style>

    <script>
        document.getElementById('methaneForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const emitId = document.getElementById('emitId').value;

            // Hide any previous results/errors and show loading
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';

            try {
                // Make API request
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ emit_id: emitId })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Processing failed');
                }

                // Hide loading and show results
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';

                // Update results
                const results = data.results;

                // Update image - using the full path returned from the server
                const resultImage = document.getElementById('resultImage');
                resultImage.src = results.visualization_path;
                resultImage.onerror = function () {
                    console.error('Failed to load image:', results.visualization_path);
                    this.src = ''; // Clear the broken image
                    document.getElementById('errorSection').style.display = 'block';
                    document.getElementById('errorMessage').textContent = 'Failed to load result image';
                };

                // Update location information
                const locationInfo = document.getElementById('locationInfo');
                locationInfo.innerHTML = `
				<li><strong>Latitude Range:</strong> ${results.coordinates.min_lat.toFixed(4)}° to ${results.coordinates.max_lat.toFixed(4)}°</li>
				<li><strong>Longitude Range:</strong> ${results.coordinates.min_lon.toFixed(4)}° to ${results.coordinates.max_lon.toFixed(4)}°</li>
				<li><strong>Processing Date:</strong> ${results.processing_date}</li>
			`;

                // Update statistics
                const statistics = document.getElementById('statistics');
                statistics.innerHTML = `
				<li><strong>Detection Status:</strong> ${results.has_plumes ? 'Methane Plumes Detected' : 'No Significant Methane Detected'}</li>
				<li><strong>Maximum Concentration:</strong> ${results.statistics.max_concentration.toFixed(2)} ppm x m</li>
				<li><strong>Average Concentration:</strong> ${results.statistics.avg_concentration.toFixed(2)} ppm x m</li>
				<li><strong>Affected Area:</strong> ${results.statistics.percentage_significant.toFixed(2)}% of image</li>
				<li><strong>Processing Time:</strong> ${data.processing_time.toFixed(2)} seconds</li>
			`;

                // Scroll to results// Generate conclusion
                // Generate conclusion
                console.log("Calling generateConclusion with results:", results);  // Debug log
                await generateConclusion(results);
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                // Hide loading and show error
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('errorSection').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message || 'An error occurred during processing';
                document.getElementById('conclusionSection').style.display = 'none';
            }
        });
                    async function generateConclusion(results) {
                        try {
                            console.log("Starting conclusion generation");
                            console.log("Results data:", results);  // Debug log

                            const response = await fetch('/generate_conclusion', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(results)
                            });

                            if (!response.ok) {
                                const errorText = await response.text();
                                console.error("Server response:", errorText);  // Debug log
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            const data = await response.json();
                            console.log("Received conclusion data:", data);  // Debug log

                            document.getElementById('conclusionSection').style.display = 'block';
                            if (data.status === 'success') {
                                document.getElementById('conclusionText').innerHTML = `
                <p>${data.conclusion}</p>
            `;
                            } else {
                                throw new Error(data.message || 'Failed to generate conclusion');
                            }
                        } catch (error) {
                            console.error("Error in generateConclusion:", error);  // Debug log
                            document.getElementById('conclusionSection').style.display = 'block';
                            document.getElementById('conclusionText').innerHTML = `
            <p class="error">Unable to generate conclusion: ${error.message}</p>
        `;
                        }
                    }
                </script>
    {{ chat_widget()|safe }}
</body>

</html>
